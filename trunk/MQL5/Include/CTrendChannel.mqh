//+------------------------------------------------------------------+
//|                                                CTrendChannel.mqh |
//|                        Copyright 2014, MetaQuotes Software Corp. |
//|                                              http://www.mql5.com |
//+------------------------------------------------------------------+
#property copyright "Copyright 2014, MetaQuotes Software Corp."
#property link      "http://www.mql5.com"
//+------------------------------------------------------------------+
//| Класс трендовых линий и каналов                                  |
//+------------------------------------------------------------------+
// подключение необходимых библиотек
#include <ChartObjects/ChartObjectsLines.mqh> // для рисования линий тренда
#include <DrawExtremums/CExtremum.mqh> // класс экстремумов
#include <DrawExtremums/CExtrContainer.mqh> // контейнер экстремумов
#include <CompareDoubles.mqh> // для сравнения вещественных чисел
#include <Arrays\ArrayObj.mqh> // класс динамических массивов

// класс трендовых каналов
class CTrend : public CObject
 {
  private:
   CExtremum *_extrUp0,*_extrUp1; // экстремумы верхней линии
   CExtremum *_extrDown0,*_extrDown1; // экстремумы нижней линии
   CChartObjectTrend _trendLine; // объект класса трендовой линии
   int _direction; // направление тренда 
   long _chartID;  // ID графика  
   string _symbol; // символ
   ENUM_TIMEFRAMES _period; // период
   string _trendUpName; // уникальное имя трендовой верхней линии
   string _trendDownName; // уникальное имя трендовой нижней линии
   // приватные методы класса
   void GenUniqName (); // генерирует уникальное имя трендового канала
   bool IsItTrend (); // метод проверяет, является ли создаваемый объект трендом. 
  public:
   CTrend(int chartID, string symbol, ENUM_TIMEFRAMES period,CExtremum *extrUp0,CExtremum *extrUp1,CExtremum *extrDown0,CExtremum *extrDown1); // конструктор класса по экстр
  ~CTrend(); // деструктор класса
   // методы класса
   int  GetDirection () { return (_direction); }; // возвращает направление тренда 
   void ShowTrend (); // показывает тренд на графике
   void HideTrend (); // скрывает отображение тренда
 };
 
// кодирование методов класса трендовых каналов

/////////приватные методы класса

void CTrend::GenUniqName(void) // генерирует уникальное имя трендового канала
 {
  // генерит уникальные имена трендовых линий исходя из символа, периода и времени первого экстремума
  _trendUpName = "trendUp."+_symbol+"."+PeriodToString(_period)+"."+TimeToString(_extrUp0.time);
  _trendDownName = "trendDown."+_symbol+"."+PeriodToString(_period)+"."+TimeToString(_extrDown0.time);  
 }
 
bool CTrend::IsItTrend(void) // проверяет, является ли данный канал трендовым
 {
  /*
  double h1,h2;
  // вычисляем расстояния h1,h2
  h1 = MathAbs(extrs[0].price - extrs[2].price);
  h2 = MathAbs(extrs[1].price - extrs[3].price);
    
  // если тренд вверх 
  if (GreatDoubles(_extrUp0.price,_extrUp1.price) && GreatDoubles(_extrDown0.price,_extrDown1.price))
   {
    // если последний экстремум - вниз
    if (_extrDown0.time > _extrUp0.time)
     {
      H1 = extrs[1].price - extrs[2].price;
      H2 = extrs[3].price - extrs[2].price;
      // если наша трендовая линия нас удовлетворяет
      if (GreatDoubles(h1,H1*percent) && GreatDoubles(h2,H2*percent) )
       return (1);
     }
   }
  // если тренд вниз
  if (LessDoubles(_extrUp0.price,_extrUp1.price) && LessDoubles(_extrDown0.price,_extrDown1.price))
   {
    // если  последний экстремум - вверх
    if (_extrUp0.time > _extrDown0.time)
     {
      H1 = extrs[1].price - extrs[2].price;
      H2 = extrs[3].price - extrs[2].price;
      // если наша трендования линия нас удовлетворяет
      if (GreatDoubles(h1,H1*percent) && GreatDoubles(h2,H2*percent) )    
       return (-1);
     }
   }   
   */
  return (true);
 }

CTrend::CTrend(int chartID,string symbol,ENUM_TIMEFRAMES period,CExtremum *extrUp0,CExtremum *extrUp1,CExtremum *extrDown0,CExtremum *extrDown1)
 {
  // сохраняем поля класса
  _chartID = chartID;
  _symbol = symbol;
  _period = period;
  // создаем объекты экстремумов для трендовых линий
  _extrUp0   = new CExtremum(extrUp0.direction,extrUp0.price,extrUp0.time,extrUp0.state);
  _extrUp1   = new CExtremum(extrUp1.direction,extrUp1.price,extrUp1.time,extrUp1.state);
  _extrDown0 = new CExtremum(extrDown0.direction,extrDown0.price,extrDown0.time,extrDown0.state);
  _extrDown1 = new CExtremum(extrDown1.direction,extrDown1.price,extrDown1.time,extrDown1.state);   
  // генерируем уникальные имена трендовых линий
  GenUniqName();   
  // отображаем трендовые линии
  ShowTrend();
 }
 
// деструктор класса
CTrend::~CTrend()
 {
 
 }

void CTrend::ShowTrend(void) // отображает тренд на графике
 {
  _trendLine.Create(_chartID,_trendUpName,0,_extrUp0.time,_extrUp0.price,_extrUp1.time,_extrUp1.price); // верхняя линия
  _trendLine.Create(_chartID,_trendDownName,0,_extrDown0.time,_extrDown0.price,_extrDown1.time,_extrDown1.price); // верхняя линия  
 }

void CTrend::HideTrend(void) // скрывает тренд с графика
 {
  ObjectDelete(_chartID,_trendUpName);
  ObjectDelete(_chartID,_trendDownName);
 }

class CTrendChannel 
 {
  private:
   int _handleDE; // хэндл индикатора DrawExtremums
   int _chartID; //ID графика
   string _symbol; // символ
   ENUM_TIMEFRAMES _period; // период
   CExtrContainer *_container; // контейнер экстремумов
   CArrayObj _bufferTrend;// буфер для хранения трендовых линий  
  public:
   CTrendChannel(int chartID,string symbol,ENUM_TIMEFRAMES period,int handleDE); // конструктор класса
  ~CTrendChannel(); // деструктор класса
  // методы класса
  CTrend * GetTrendByIndex (int index); // возвращает указатель на тренд по индексу
 };
 
// кодирование методов класса CTrendChannel
CTrendChannel::CTrendChannel(int chartID, string symbol,ENUM_TIMEFRAMES period,int handleDE)
 {
  int i;
  int extrTotal;
  int dirLastExtr;
  
  _chartID = chartID;
  _handleDE = handleDE;
  _symbol = symbol;
  _period = period;
  _container = new CExtrContainer(handleDE,symbol,period);
  // если удалось создать объект контейнера
  if (_container != NULL)
   {
    _container.Upload(0);
    // если удалось прогрузить все экстремумы на истории 
    if (_container.isUploaded())
     {    
      extrTotal = _container.GetCountFormedExtr(); // получаем количество экстремумов
      dirLastExtr = _container.GetLastFormedExtr(EXTR_BOTH).direction; // получаем последнее значение экстремума
      // проходим по экстремумам и заполняем буфер трендов
      for (i=0;i<extrTotal-4;i++)
       {
        // если последнее направление тренда - вверх
        if (dirLastExtr == 1)
         {
          _bufferTrend.Add(new CTrend(_chartID, _symbol, _period,_container.GetExtrByIndex(i),_container.GetExtrByIndex(i+2),_container.GetExtrByIndex(i+1),_container.GetExtrByIndex(i+3) ) );
         }
        // если последнее направление тренда - вниз
        if (dirLastExtr == -1)
         {
          _bufferTrend.Add(new CTrend(_chartID, _symbol, _period,_container.GetExtrByIndex(i+1),_container.GetExtrByIndex(i+3),_container.GetExtrByIndex(i),_container.GetExtrByIndex(i+2) ) );
         }
        dirLastExtr = -dirLastExtr; 
       }
     }
   }
 }
 
// деструктор класса
CTrendChannel::~CTrendChannel()
 {
  
 }